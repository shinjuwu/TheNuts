# TheNuts å¤šéŠæˆ²åšå¼ˆæ¡†æ¶ - æ¶æ§‹è¨­è¨ˆæ–‡æª”

## ğŸ¯ è¨­è¨ˆç›®æ¨™

æ§‹å»ºä¸€å€‹**å¯æ“´å±•çš„å•†æ¥­åŒ–åšå¼ˆéŠæˆ²æ¡†æ¶**ï¼Œæ”¯æ´ï¼š
- æ£‹ç‰Œé¡éŠæˆ²ï¼ˆå¾·å·æ’²å…‹ã€ç™¾å®¶æ¨‚ã€21é»ç­‰ï¼‰
- é›»å­éŠæˆ²ï¼ˆè€è™æ©Ÿã€è¼ªç›¤ç­‰ï¼‰
- è¦–è¨ŠéŠæˆ²ï¼ˆçœŸäººè·å®˜ï¼‰

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ§‹

### 1. åˆ†å±¤æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presentation Layer (è¡¨ç¾å±¤)                     â”‚
â”‚  - WebSocket Gateway                            â”‚
â”‚  - HTTP API                                     â”‚
â”‚  - Admin Dashboard                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer (æ‡‰ç”¨å±¤)                      â”‚
â”‚  - GameService (éŠæˆ²æœå‹™çµ±ä¸€å…¥å£)                â”‚
â”‚  - PlayerSession (ç©å®¶æœƒè©±ç®¡ç†)                  â”‚
â”‚  - TableManager (æ¡Œå­ç®¡ç†å™¨)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Poker    â”‚ â”‚ Slot    â”‚ â”‚ Baccarat â”‚
â”‚ Engine   â”‚ â”‚ Engine  â”‚ â”‚ Engine   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚         â”‚         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Domain Layer (é ˜åŸŸå±¤)                           â”‚
â”‚  - GameEngine Interface                         â”‚
â”‚  - Common Game Logic                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Infrastructure Layer (åŸºç¤è¨­æ–½å±¤)               â”‚
â”‚  - Database (ç©å®¶è³‡æ–™ã€éŠæˆ²è¨˜éŒ„)                 â”‚
â”‚  - RNG Service (éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨)                    â”‚
â”‚  - Wallet Service (éŒ¢åŒ…æœå‹™)                     â”‚
â”‚  - Audit Log (å¯©è¨ˆæ—¥èªŒ)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒä»‹é¢è¨­è¨ˆ

#### GameEngine ä»‹é¢
æ‰€æœ‰éŠæˆ²å¼•æ“å¿…é ˆå¯¦ç¾çš„å¥‘ç´„ï¼š

```go
type GameEngine interface {
    GetType() GameType
    Initialize(config GameConfig) error
    Start(ctx context.Context) error
    Stop() error
    HandleAction(ctx context.Context, action PlayerAction) (*ActionResult, error)
    GetState() GameState
    AddPlayer(player *Player) error
    RemovePlayer(playerID string) error
    BroadcastEvent(event GameEvent)
}
```

**è¨­è¨ˆæ€æƒ³**ï¼š
- é€šéä»‹é¢éš”é›¢ï¼Œæ¯ç¨®éŠæˆ²å¯ä»¥ç¨ç«‹é–‹ç™¼å’Œæ¸¬è©¦
- çµ±ä¸€çš„å‹•ä½œè™•ç†æµç¨‹ï¼Œæ–¹ä¾¿ç›£æ§å’Œå¯©è¨ˆ
- æ”¯æ´æ°´å¹³æ“´å±•ï¼ˆä¸åŒéŠæˆ²å¯éƒ¨ç½²åœ¨ä¸åŒæœå‹™å™¨ï¼‰

#### GameConfig é…ç½®
```go
type GameConfig struct {
    GameID      string
    MaxPlayers  int
    MinBet      int64
    MaxBet      int64
    RakePercent float64
    Timeout     time.Duration
    CustomData  map[string]interface{} // éŠæˆ²å°ˆå±¬é…ç½®
}
```

**æ“´å±•æ€§**ï¼š
- `CustomData` å…è¨±æ¯ç¨®éŠæˆ²æ·»åŠ å°ˆå±¬é…ç½®
- ä¾‹å¦‚ï¼šå¾·æ’²çš„ç›²æ³¨çµæ§‹ã€è€è™æ©Ÿçš„RTPã€ç™¾å®¶æ¨‚çš„ä½£é‡‘æ¯”ä¾‹

### 3. éŠæˆ²è¨»å†Šæ©Ÿåˆ¶ï¼ˆå·¥å» æ¨¡å¼ï¼‰

```go
// å•Ÿå‹•æ™‚è¨»å†ŠéŠæˆ²å¼•æ“
gameService := core.NewGameService()
gameService.RegisterGameEngine(core.GameTypePoker, &poker.PokerEngineFactory{})
gameService.RegisterGameEngine(core.GameTypeSlot, &slot.SlotEngineFactory{})
gameService.RegisterGameEngine(core.GameTypeBaccarat, &baccarat.BaccaratEngineFactory{})
```

**å„ªé»**ï¼š
- æ’ä»¶å¼æ¶æ§‹ï¼Œæ–°å¢éŠæˆ²ç„¡éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç¢¼
- æ”¯æ´å‹•æ…‹è¼‰å…¥ï¼ˆæœªä¾†å¯å¯¦ç¾ç†±æ›´æ–°ï¼‰
- æ–¹ä¾¿ A/B æ¸¬è©¦ï¼ˆåŒä¸€éŠæˆ²é¡å‹çš„ä¸åŒç‰ˆæœ¬ï¼‰

### 4. ç©å®¶æœƒè©±ç®¡ç†

```go
type PlayerSession struct {
    SessionID     string
    PlayerID      string
    CurrentGameID string  // ç•¶å‰æ‰€åœ¨éŠæˆ²æ¡Œ
    GameType      GameType
    Balance       int64
    SendCh        chan []byte // WebSocket ç™¼é€é€šé“
}
```

**é—œéµç‰¹æ€§**ï¼š
- è·¨éŠæˆ²å…±ç”¨çš„æœƒè©±å±¤ï¼ˆç©å®¶å¯ä»¥åœ¨ä¸åŒéŠæˆ²é–“åˆ‡æ›ï¼‰
- çµ±ä¸€çš„é¤˜é¡ç®¡ç†ï¼ˆé¿å…é‡è¤‡æ‰£æ¬¾ï¼‰
- æ–·ç·šé‡é€£æ”¯æ´ï¼ˆé€šé SessionID æ¢å¾©ï¼‰

### 5. äº‹ä»¶é©…å‹•æ¶æ§‹

```go
type GameEvent struct {
    EventType      EventType
    GameID         string
    Timestamp      time.Time
    Data           interface{}
    TargetPlayerID string  // è¦–è§’éæ¿¾
}
```

**äº‹ä»¶é¡å‹**ï¼š
- `EventGameStart` - éŠæˆ²é–‹å§‹
- `EventPlayerJoin` - ç©å®¶åŠ å…¥
- `EventBetPlaced` - ä¸‹æ³¨
- `EventCardDealt` - ç™¼ç‰Œ
- `EventWinner` - çµç®—

**è¦–è§’éæ¿¾**ï¼š
- `TargetPlayerID` ç‚ºç©º = å»£æ’­çµ¦æ‰€æœ‰äºº
- `TargetPlayerID` æœ‰å€¼ = åªç™¼çµ¦ç‰¹å®šç©å®¶ï¼ˆä¾‹å¦‚ç§äººæ‰‹ç‰Œï¼‰

## ğŸ”Œ å¦‚ä½•æ·»åŠ æ–°éŠæˆ²

### æ­¥é©Ÿ 1: å¯¦ç¾ GameEngine ä»‹é¢

```go
package slot

type SlotEngine struct {
    config core.GameConfig
    reels  [][]string  // è€è™æ©Ÿæ»¾è¼ª
    // ... å…¶ä»–éŠæˆ²å°ˆå±¬é‚è¼¯
}

func (e *SlotEngine) GetType() core.GameType {
    return core.GameTypeSlot
}

func (e *SlotEngine) HandleAction(ctx context.Context, action core.PlayerAction) (*core.ActionResult, error) {
    if action.Type == core.ActionSpin {
        // è™•ç†æ—‹è½‰é‚è¼¯
        result := e.spin()
        return &core.ActionResult{
            Success: true,
            Data: result,
        }, nil
    }
    return nil, fmt.Errorf("invalid action")
}

// ... å¯¦ç¾å…¶ä»–ä»‹é¢æ–¹æ³•
```

### æ­¥é©Ÿ 2: å‰µå»ºå·¥å» 

```go
type SlotEngineFactory struct{}

func (f *SlotEngineFactory) Create(config core.GameConfig) (core.GameEngine, error) {
    return &SlotEngine{
        config: config,
        reels:  loadReelsFromConfig(config),
    }, nil
}
```

### æ­¥é©Ÿ 3: è¨»å†Šå¼•æ“

```go
gameService.RegisterGameEngine(core.GameTypeSlot, &slot.SlotEngineFactory{})
```

### æ­¥é©Ÿ 4: å‰µå»ºéŠæˆ²å¯¦ä¾‹

```go
slotConfig := core.GameConfig{
    GameID: "slot_001",
    CustomData: map[string]interface{}{
        "rtp": 0.96,
        "paylines": 20,
    },
}
gameService.CreateGame(core.GameTypeSlot, slotConfig)
```

## ğŸ” å®‰å…¨è€ƒé‡

### 1. è¦–è§’éš”é›¢
- å»£æ’­äº‹ä»¶æ™‚ï¼Œæ ¹æ“š `TargetPlayerID` éæ¿¾æ•¸æ“š
- å¾·æ’²ä¸­å…¶ä»–ç©å®¶çš„æ‰‹ç‰Œä¸å¾—æ´©éœ²

### 2. å‹•ä½œé©—è­‰
```go
// æ¯å€‹å¼•æ“å¿…é ˆé©—è­‰å‹•ä½œåˆæ³•æ€§
func (e *PokerEngine) HandleAction(action core.PlayerAction) {
    // 1. é©—è­‰æ˜¯å¦è¼ªåˆ°è©²ç©å®¶
    // 2. é©—è­‰å‹•ä½œæ˜¯å¦åˆæ³•ï¼ˆä¸èƒ½åœ¨ PreFlop æ£„ç‰Œæ™‚ä¸‹æ³¨ï¼‰
    // 3. é©—è­‰é‡‘é¡æ˜¯å¦è¶³å¤ 
}
```

### 3. éš¨æ©Ÿæ•¸å®‰å…¨
- ä½¿ç”¨ `crypto/rand` è€Œé `math/rand`
- æ´—ç‰Œç®—æ³•æ¡ç”¨ Fisher-Yates

### 4. å¯©è¨ˆæ—¥èªŒ
- æ‰€æœ‰ç©å®¶å‹•ä½œè¨˜éŒ„åˆ° Audit Log
- åŒ…å«æ™‚é–“æˆ³ã€ç©å®¶IDã€å‹•ä½œé¡å‹ã€é‡‘é¡

## ğŸ“Š ç›£æ§èˆ‡å¯è§€æ¸¬æ€§

### é—œéµæŒ‡æ¨™ (å¾…å¯¦ç¾)
- æ¯ç§’å‹•ä½œæ•¸ (Actions per Second)
- éŠæˆ²å¹³å‡è€—æ™‚
- ç©å®¶å‹ç‡åˆ†ä½ˆ
- ç•°å¸¸å‹•ä½œæª¢æ¸¬ï¼ˆä½œå¼Šæª¢æ¸¬ï¼‰

### æ—¥èªŒçµæ§‹
```go
{
    "timestamp": "2026-01-22T18:00:00Z",
    "game_id": "poker_001",
    "player_id": "alice",
    "action": "raise",
    "amount": 100,
    "result": "success"
}
```

## ğŸš€ æœªä¾†æ“´å±•

### 1. å¤šæ¡ŒéŒ¦æ¨™è³½ (MTT)
- éœ€è¦ TournamentManager
- å¯¦ç¾ä½µæ¡Œé‚è¼¯
- ç›²æ³¨çµæ§‹ç®¡ç†

### 2. åˆ†æ•£å¼éƒ¨ç½²
- ä½¿ç”¨ Redis Pub/Sub è™•ç†è·¨æœå‹™å™¨å»£æ’­
- ä½¿ç”¨ etcd é€²è¡Œæœå‹™ç™¼ç¾

### 3. éŠæˆ²å›æ”¾
- è¨˜éŒ„å®Œæ•´çš„ GameEvent æµ
- æ”¯æ´å›æ”¾å’Œçˆ­è­°è™•ç†

### 4. AI å°æ‰‹
- å¯¦ç¾ BotPlayer
- æ”¯æ´ä¸åŒé›£åº¦ç­‰ç´š

## ğŸ“ æª”æ¡ˆçµæ§‹

```
internal/game/
â”œâ”€â”€ core/                    # æ ¸å¿ƒæŠ½è±¡å±¤
â”‚   â”œâ”€â”€ game_engine.go       # GameEngine ä»‹é¢å®šç¾©
â”‚   â”œâ”€â”€ table_manager.go     # æ¡Œå­ç®¡ç†å™¨
â”‚   â””â”€â”€ service.go           # éŠæˆ²æœå‹™çµ±ä¸€å…¥å£
â”‚
â”œâ”€â”€ poker/                   # å¾·å·æ’²å…‹å¼•æ“
â”‚   â”œâ”€â”€ poker_engine.go      # å¯¦ç¾ GameEngine
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ slot/                    # è€è™æ©Ÿå¼•æ“ (å¾…å¯¦ç¾)
â”‚   â””â”€â”€ slot_engine.go
â”‚
â”œâ”€â”€ baccarat/                # ç™¾å®¶æ¨‚å¼•æ“ (å¾…å¯¦ç¾)
â”‚   â””â”€â”€ baccarat_engine.go
â”‚
â”œâ”€â”€ domain/                  # é ˜åŸŸå±¤ (ç¾æœ‰å¾·æ’²é‚è¼¯)
â”‚   â”œâ”€â”€ table.go
â”‚   â”œâ”€â”€ player.go
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ adapter/                 # é©é…å™¨å±¤
    â””â”€â”€ ws/                  # WebSocket é©é…å™¨
```

## ğŸ“ è¨­è¨ˆæ¨¡å¼æ‡‰ç”¨

1. **å·¥å» æ¨¡å¼** - GameEngineFactory
2. **ç­–ç•¥æ¨¡å¼** - ä¸åŒéŠæˆ²å¼•æ“å¯¦ç¾åŒä¸€ä»‹é¢
3. **è§€å¯Ÿè€…æ¨¡å¼** - GameEvent å»£æ’­æ©Ÿåˆ¶
4. **é©é…å™¨æ¨¡å¼** - å°‡ç¾æœ‰ domain.Table é©é…åˆ° GameEngine
5. **å–®ä¾‹æ¨¡å¼** - GameService å…¨å±€å”¯ä¸€

## âœ… ä¸‹ä¸€æ­¥å»ºè­°

1. **å®Œå–„å¾·æ’²å¼•æ“**
   - å¯¦ç¾ç›²æ³¨é‚è¼¯ï¼ˆå·²åœ¨ CODE_REVIEW.md æŒ‡å‡ºï¼‰
   - å¯¦ç¾éŒ¦æ¨™è³½ç®¡ç†å™¨
   
2. **å¯¦ç¾ç¬¬äºŒå€‹éŠæˆ²å¼•æ“**
   - å»ºè­°å¾ç°¡å–®çš„è€è™æ©Ÿé–‹å§‹
   - é©—è­‰æ¡†æ¶çš„é€šç”¨æ€§
   
3. **æ·»åŠ æŒä¹…åŒ–å±¤**
   - ç©å®¶é¤˜é¡æŒä¹…åŒ–
   - éŠæˆ²æ­·å²è¨˜éŒ„
   
4. **æ·»åŠ èªè­‰æˆæ¬Š**
   - JWT Token é©—è­‰
   - é˜²ä½œå¼Šæ©Ÿåˆ¶

5. **æ€§èƒ½å„ªåŒ–**
   - å£“åŠ›æ¸¬è©¦ï¼ˆæ¨¡æ“¬ 1000+ ä¸¦ç™¼æ¡Œï¼‰
   - å…§å­˜å„ªåŒ–
   - ä½¿ç”¨ Protobuf æ›¿ä»£ JSON
