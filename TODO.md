# TheNuts 開發待辦清單

## 🔴 緊急 (Critical) - 必須在上線前完成

### 1. ~~修復盲注邏輯~~ ✅ 已完成
- [x] 實現 `postBlinds()` 函數 (table.go:78-195)
- [x] 處理小盲/大盲自動扣除
- [x] 處理玩家籌碼不足盲注的情況 (All-in)
- [x] 處理 Heads-up (兩人) 時的特殊盲注規則
- [x] 添加盲注相關測試 (7個測試，100%通過)

**完成時間**: 2026-01-26  
**測試結果**: 7/7 通過 ✅  
**代碼位置**: `internal/game/domain/table.go:78-195`  
**測試檔案**: `internal/game/domain/blinds_test.go`

#### 已實作功能
- ✅ 標準多人桌盲注 (3-9人)
- ✅ Heads-Up 特殊規則 (Button = SB)
- ✅ 籌碼不足自動 All-in
- ✅ 單人桌保護 (不扣盲注)
- ✅ 盲注金額計算 (SB = BB/2)
- ✅ 狀態正確更新 (StatusAllIn)
- ✅ 詳細日誌輸出

#### 建議改進 (非阻塞)
- ⚠️ 暫離玩家跳過邏輯可優化
- ⚠️ 盲注配置可從配置文件讀取

---

### 2. ~~WebSocket 認證機制~~ ✅ 已完成
- [x] 實現 JWT Token 驗證
- [x] 實現票券機制 (Ticket-based Authentication)
- [x] 在 `ws/handler.go` 添加認證中間件
- [x] 防止偽造 PlayerID
- [x] 實現完整認證流程 (登入 → JWT → 票券 → WebSocket)

**完成時間**: 2026-01-26  
**實作方式**: 票券機制 (業界最佳實踐) ✅  
**代碼位置**: `internal/auth/`  
**文檔**: `AUTHENTICATION_IMPLEMENTATION_SUMMARY.md`, `docs/AUTHENTICATION.md`

#### 已實作功能
- ✅ JWT Token 生成與驗證 (HMAC-SHA256)
- ✅ 票券儲存 (MemoryTicketStore)
- ✅ 30秒一次性票券 (防重放攻擊)
- ✅ JWT 中介層 (middleware.go)
- ✅ 認證 HTTP Handler (login, ticket)
- ✅ 測試客戶端 (test-client.html)
- ✅ 完整文檔 (1000+ 行)

#### 待實作 (生產環境)
- ⏳ 真實使用者驗證 (數據庫)
- ⏳ bcrypt 密碼雜湊
- ⏳ HTTPS/WSS
- ⏳ CORS 白名單
- ⏳ 速率限制
- ⏳ Token 刷新機制
- ⏳ Redis 票券儲存 (分散式部署)

---

### 3. ~~邊池 (Side Pot) 完善~~ ✅ 已完成
- [x] 驗證當前 `pot.go` 的邊池邏輯
- [x] 測試多人 All-in 的複雜場景
- [x] 確保分配正確性

**完成時間**: 2026-01-26  
**演算法**: Slicing Algorithm (業界標準) ✅  
**測試結果**: 3/3 通過 ✅  
**代碼位置**: `internal/game/domain/pot.go`  
**測試檔案**: `internal/game/domain/pot_test.go`

#### 已實作功能
- ✅ Main Pot 計算
- ✅ Side Pot 自動切分
- ✅ 多輪下注合併
- ✅ Contributors 追蹤
- ✅ Distributor 正確過濾 Folded 玩家
- ✅ 複雜場景測試 (P1:100, P2:200, P3:500)

#### 測試覆蓋
- ✅ 單一 Main Pot 場景
- ✅ 多邊池場景 (3個Pot)
- ✅ 多輪下注合併測試

---

## 🟡 重要 (High) - 商業化必需

### 4. 持久化層
- [ ] 設計數據庫模型 (PostgreSQL)
  - [ ] Players 表 (玩家資料)
  - [ ] Games 表 (遊戲記錄)
  - [ ] HandHistory 表 (手牌歷史)
  - [ ] Transactions 表 (資金流水)
- [ ] 實現 Repository 層
- [ ] 添加數據庫遷移腳本 (使用 golang-migrate)

**預估工時**: 12-16 小時  
**優先級**: 🟡 P1  
**負責人**: 待分配

### 5. 錢包服務 (Wallet Service)
- [ ] 玩家餘額管理
- [ ] 買入 (Buy-in) 扣款
- [ ] 兌現 (Cash-out) 加款
- [ ] 交易原子性保證 (Database Transaction)
- [ ] 防止重複扣款

**預估工時**: 8-10 小時  
**優先級**: 🟡 P1  
**負責人**: 待分配

### 6. 審計日誌 (Audit Log)
- [ ] 記錄所有玩家動作
- [ ] 記錄資金變動
- [ ] 支援查詢和回放
- [ ] 集成到監控系統 (Prometheus/Grafana)

**預估工時**: 6-8 小時  
**優先級**: 🟡 P1  
**負責人**: 待分配

---

## 🟢 中等 (Medium) - 功能增強

### 7. 錦標賽管理器 (Tournament Manager)
- [ ] 盲注結構配置
- [ ] 自動漲盲定時器
- [ ] 併桌 (Table Balancing) 邏輯
- [ ] Breaking table 邏輯
- [ ] 獎池分配計算
- [ ] Hand-for-Hand 同步機制 (錢圈時)

**預估工時**: 20-24 小時  
**優先級**: 🟢 P2  
**負責人**: 待分配

### 8. 斷線重連
- [ ] 會話持久化 (Redis)
- [ ] 斷線後保留座位 (Sitting Out)
- [ ] 重連時發送完整狀態快照
- [ ] 超時自動 Fold/Check

**預估工時**: 8-10 小時  
**優先級**: 🟢 P2  
**負責人**: 待分配

### 9. 實現第二個遊戲引擎
- [ ] 選擇遊戲類型 (建議: 老虎機 Slot 或百家樂 Baccarat)
- [ ] 實現 GameEngine 介面
- [ ] 編寫測試
- [ ] 驗證多遊戲框架的通用性

**預估工時**: 16-20 小時  
**優先級**: 🟢 P2  
**負責人**: 待分配

---

## 🔵 低優先級 (Low) - 優化和擴展

### 10. 性能優化
- [ ] 壓力測試 (1000+ 並發桌)
- [ ] 內存優化 (使用 sync.Pool)
- [ ] 使用 Protobuf 替代 JSON
- [ ] CPU Profiling 和優化熱點代碼

**預估工時**: 12-16 小時  
**優先級**: 🔵 P3  
**負責人**: 待分配

### 11. 監控和可觀測性
- [ ] Prometheus 指標接口
- [ ] Grafana 儀表板
- [ ] 分佈式追蹤 (OpenTelemetry)
- [ ] 錯誤告警 (Alertmanager)

**預估工時**: 10-12 小時  
**優先級**: 🔵 P3  
**負責人**: 待分配

### 12. 管理後台 (Admin Dashboard)
- [ ] 查看在線玩家
- [ ] 查看活躍桌子
- [ ] 手動控制遊戲 (暫停/關閉)
- [ ] 查看資金統計
- [ ] 異常檢測和作弊檢測

**預估工時**: 24-32 小時  
**優先級**: 🔵 P3  
**負責人**: 待分配

---

## 🎯 架構調整 (與多遊戲框架相關)

### ✅ 已完成
- [x] 定義 `GameEngine` 核心介面 (2026-01-22)
- [x] 實現 `TableManager` (2026-01-22)
- [x] 實現 `GameService` 統一入口 (2026-01-22)
- [x] 創建 `PokerEngine` 適配器 (2026-01-22)
- [x] 編寫架構文檔 (2026-01-22)
- [x] 編寫遷移指南 (2026-01-22)
- [x] 創建示例程序 (2026-01-22)
- [x] 修復盲注邏輯 (2026-01-26) ✅
- [x] 實作 WebSocket 認證系統 (2026-01-26) ✅
- [x] 驗證邊池邏輯 (2026-01-26) ✅

### 🔄 進行中
- [ ] 將 WebSocket Handler 改為使用 GameService (建議下一步)
- [ ] 添加更多遊戲事件類型
- [ ] 完善視角過濾機制

### ⏳ 待開始
- [ ] 實現完整的事件廣播系統
- [ ] 添加遊戲錄像回放功能
- [ ] 實現遊戲狀態序列化 (用於斷線重連)

---

## 📅 建議排程 (6 週計劃)

### Week 1: 緊急問題修復
- 修復盲注邏輯
- 添加 WebSocket 認證
- 驗證邊池邏輯

### Week 2: 架構遷移
- 將 WebSocket 層改為使用 GameService
- 運行整合測試
- 修復兼容性問題

### Week 3: 持久化和錢包
- 實現數據庫層
- 實現錢包服務
- 添加審計日誌

### Week 4: 錦標賽功能
- 實現盲注結構
- 實現併桌邏輯
- 測試多桌錦標賽

### Week 5: 第二個遊戲引擎
- 選擇並實現新遊戲 (老虎機/百家樂)
- 驗證框架通用性
- 優化性能

### Week 6: 監控和上線準備
- 添加監控指標
- 壓力測試
- 文檔完善
- 生產環境部署

---

## 🛠️ 技術債務 (Tech Debt)

- [ ] 移除 `德撲開發.md` 中的臨時代碼片段
- [ ] 統一錯誤處理方式 (使用 `pkg/errors`)
- [ ] 添加更多單元測試 (目標覆蓋率 80%+)
- [ ] 代碼風格統一 (使用 golangci-lint)
- [ ] 添加 CI/CD Pipeline (GitHub Actions)
- [ ] 依賴版本管理 (定期更新 go.mod)

---

## 📊 進度追蹤

**總任務數**: 42  
**已完成**: 10 (24%) ⬆️  
**進行中**: 3 (7%)  
**未開始**: 29 (69%) ⬇️  

**預估總工時**: 180-220 小時  
**已投入**: ~20 小時  
**當前階段**: 核心功能開發階段 → P0 任務已完成 ✅

### 最近完成 (2026-01-26)
- ✅ 盲注邏輯實作 (7個測試通過)
- ✅ WebSocket 認證系統 (票券機制)
- ✅ 邊池邏輯驗證 (3個測試通過)

### 測試統計
- Domain 層測試: 23/23 通過 (100%) ✅
- 認證系統: 功能完整，文檔齊全 ✅
- 完整遊戲流程: 測試通過 ✅

---

## 💬 備註

- 優先級標記:
  - 🔴 P0 = 阻塞上線的嚴重問題
  - 🟡 P1 = 商業化必需功能
  - 🟢 P2 = 重要但可延後
  - 🔵 P3 = 優化和增強

- 建議先完成 P0 和 P1 任務再考慮 P2/P3
- 每個任務完成後記得:
  1. 更新此 TODO.md
  2. 提交 Git Commit
  3. 更新相關文檔
  4. 通知團隊成員

---

## 🎯 下一步重點 (基於當前進度)

### 立即可開始的任務
1. **持久化層設計** (🟡 P1) - 數據庫 Schema 設計
2. **Wallet Service** (🟡 P1) - 餘額管理系統
3. **WebSocket Handler 改造** (🟡 P1) - 使用 GameService

### 建議順序
```
Week 1-2: 持久化層 + Wallet Service
Week 3-4: WebSocket 整合 + 審計日誌
Week 5-6: 錦標賽功能 + 第二個遊戲引擎
```

---

最後更新: 2026-01-26  
上次 Review: 盲注、邊池、認證系統 - 全部完成 ✅
